<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Individual Application - Florida Estates Phase 2 | Rio Tierra Real Estate</title>
  <meta name="description" content="Apply for premium residential lots in Florida Estates Phase 2. Fast, secure application process with digital signatures.">
  <meta name="keywords" content="Florida Estates, residential lots, real estate application, Rio Tierra">
  <meta name="author" content="Rio Tierra Real Estate">
  
  <meta property="og:title" content="Individual Application - Florida Estates Phase 2">
  <meta property="og:description" content="Apply for premium residential lots in Florida Estates Phase 2">
  <meta property="og:type" content="website">
  <meta property="og:image" content="/Rio Tierra Logo.webp">
  
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preload" href="/Rio Tierra Logo.webp" as="image">
  
  <style>
    :root {
      --primary: #c1743c;
      --primary-dark: #a85e2d;
      --text-dark: #1a1a1a;
      --text-medium: #4a4a4a;
      --text-light: #6b7280;
      --border-color: #e5e7eb;
      --bg-light: #fafafa;
      --bg-white: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
      --transition: all 0.25s ease;
      --border-radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      color: var(--text-dark);
      background: var(--bg-white);
      -webkit-font-smoothing: antialiased;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(245, 241, 235, 0.95);
      border-bottom: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      padding: 1rem 0;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .logo-link {
      text-decoration: none;
      transition: var(--transition);
    }

    .logo-link:hover {
      transform: translateY(-1px);
    }

    .logo {
      height: 45px;
      width: auto;
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 2rem;
      margin: 0;
    }

    .nav-links a {
      text-decoration: none;
      color: var(--text-medium);
      font-weight: 500;
      padding: 0.75rem 0;
      transition: var(--transition);
    }

    .nav-links a:hover,
    .nav-links a:focus {
      color: var(--text-dark);
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .nav-links .active {
      color: var(--text-dark);
      font-weight: 600;
      border-bottom: 2px solid var(--primary);
    }

    .main-content {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
      background: linear-gradient(135deg, var(--bg-light) 0%, #f8f9fa 100%);
    }

    .form-container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      padding: 3rem;
      border: 1px solid var(--border-color);
    }

    .form-header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
    }

    .form-title {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .document-container {
      background: #fff;
      padding: 0.75in;
      font-family: 'Times New Roman', Times, serif;
      color: #000;
      line-height: 1.4;
      font-size: 12pt;
      box-shadow: var(--shadow-sm);
      border-radius: var(--border-radius);
    }

    .form-number {
      text-align: right;
      font-size: 9pt;
      color: #666;
      margin-bottom: 1rem;
    }

    .document-title {
      text-align: center;
      font-size: 16pt;
      font-weight: bold;
      text-decoration: underline;
      margin-bottom: 1.5rem;
    }

    .form-section {
      margin-bottom: 1.5rem;
    }

    .section-label {
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: block;
      color: var(--text-dark);
    }

    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 120px;
      flex: 1;
    }

    .form-label {
      font-weight: bold;
      margin-bottom: 0.25rem;
      color: var(--text-dark);
      font-size: 14px;
    }

    .form-input {
      border: none;
      border-bottom: 2px solid #333;
      background: transparent;
      font-family: 'Times New Roman', Times, serif;
      font-size: 12pt;
      padding: 0.25rem 0.125rem;
      outline: none;
      transition: var(--transition);
      min-height: 44px;
    }

    .form-input:focus {
      background: rgba(193, 116, 60, 0.1);
      border-bottom-color: var(--primary);
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .form-input:invalid {
      border-bottom-color: #dc2626;
    }

    .buyer-table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #000;
      margin: 1rem 0;
    }

    .buyer-table th {
      background: #f9f9f9;
      font-weight: bold;
      text-align: center;
      padding: 0.75rem;
      border: 1px solid #000;
      font-size: 13pt;
    }

    .buyer-table td {
      padding: 1rem;
      vertical-align: top;
      border: 1px solid #000;
    }

    .financial-table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #000;
      margin: 1rem 0;
    }

    .financial-table th,
    .financial-table td {
      border: 1px solid #000;
      padding: 0.75rem;
    }

    .financial-table th {
      background: #f9f9f9;
      font-weight: bold;
      text-align: left;
    }

    .legal-text {
      border: 2px solid #000;
      padding: 1rem;
      margin: 1rem 0;
      font-size: 10pt;
      line-height: 1.5;
      background: #fafafa;
    }

    .signature-section {
      margin-top: 2rem;
    }

    .signature-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .signature-label {
      font-weight: bold;
      min-width: 80px;
    }

    .signature-box {
      width: 250px;
      height: 50px;
      border: 2px solid #000;
      background: #fff;
      cursor: pointer;
      position: relative;
      transition: var(--transition);
      min-height: 44px;
    }

    .signature-box:hover,
    .signature-box:focus {
      background: rgba(193, 116, 60, 0.1);
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .signature-placeholder {
      position: absolute;
      top: 50%;
      left: 0.5rem;
      transform: translateY(-50%);
      color: #666;
      font-style: italic;
      pointer-events: none;
    }

    .signature-display {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      padding: 0.5rem;
    }

    .typed-signature {
      font-family: 'Brush Script MT', cursive;
      font-size: 24px;
      color: #000080;
    }

    .drawn-signature {
      max-height: 100%;
      max-width: 100%;
    }

    .controls {
      background: #f8f9fa;
      padding: 2rem;
      text-align: center;
      margin-top: 2rem;
      border-radius: var(--border-radius);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 16px;
      cursor: pointer;
      margin: 0.5rem;
      border-radius: var(--border-radius);
      transition: var(--transition);
      min-height: 44px;
      font-weight: 600;
    }

    .btn:hover:not(:disabled),
    .btn:focus {
      background: var(--primary-dark);
      transform: translateY(-2px);
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover,
    .btn-secondary:focus {
      background: var(--primary);
      color: white;
    }

    .status-message {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: var(--border-radius);
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.success {
      background: #d4f7d4;
      color: #0f5132;
      border: 1px solid #198754;
    }

    .status-message.error {
      background: #fde2e1;
      color: #721c24;
      border: 1px solid #dc3545;
    }

    .status-message.info {
      background: #cff4fc;
      color: #055160;
      border: 1px solid #0dcaf0;
    }

    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      color: #666;
      min-height: 44px;
      min-width: 44px;
    }

    .close-btn:hover,
    .close-btn:focus {
      color: #000;
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .tab-btn {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      border-radius: var(--border-radius);
      transition: var(--transition);
      min-height: 44px;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .tab-btn:hover,
    .tab-btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .tab-content {
      display: none;
      min-height: 200px;
    }

    .tab-content.active {
      display: block;
    }

    .signature-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #ccc;
      font-size: 24px;
      text-align: center;
      font-family: 'Brush Script MT', cursive;
      color: #000080;
      border-radius: var(--border-radius);
      min-height: 44px;
    }

    .signature-input:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      border-color: var(--primary);
    }

    .signature-canvas {
      border: 2px solid #ccc;
      background: white;
      cursor: crosshair;
      width: 100%;
      height: 200px;
      border-radius: var(--border-radius);
    }

    .signature-canvas:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    @media (max-width: 768px) {
      .header-content {
        padding: 0 1rem;
      }

      .nav-links {
        gap: 1rem;
      }

      .form-container {
        padding: 2rem 1.5rem;
        margin: 0 1rem;
      }

      .form-title {
        font-size: 2rem;
      }

      .document-container {
        padding: 0.5in;
        transform: scale(0.9);
        transform-origin: top left;
        width: 111%;
        margin-bottom: -10%;
      }

      .form-row {
        flex-direction: column;
        gap: 0.5rem;
      }

      .form-group {
        min-width: unset;
      }

      .signature-row {
        flex-direction: column;
        align-items: stretch;
      }

      .signature-box {
        width: 100%;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }

      .tab-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .document-container {
        transform: scale(0.8);
        width: 125%;
        margin-bottom: -20%;
      }

      .form-container {
        padding: 1.5rem 1rem;
        margin: 0 0.5rem;
      }

      .form-title {
        font-size: 1.75rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    @media print {
      .header,
      .controls,
      .loading,
      .modal,
      .form-header {
        display: none !important;
      }

      .document-container {
        transform: none !important;
        width: 100% !important;
        margin: 0 !important;
        box-shadow: none !important;
        page-break-after: always;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo-link" aria-label="Rio Tierra Home">
        <img src="/Rio Tierra Logo.webp" alt="Rio Tierra Logo" class="logo" width="45" height="45">
      </a>
      <nav aria-label="Main navigation">
        <ul class="nav-links">
          <li><a href="/">Home</a></li>
          <li><a href="/sales/">Sales</a></li>
          <li><a href="#application" class="active" aria-current="page">Application</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="form-container">
        <header class="form-header">
          <h1 class="form-title" id="application">Individual Application Form</h1>
        </header>

        <div class="loading" id="loading" aria-hidden="true">
          <div class="spinner" aria-label="Loading"></div>
        </div>

        <div class="document-container">
          <div class="form-number">Form 2024-OFFER-001</div>
          
          <h2 class="document-title">OFFER TO PURCHASE VACANT PROPERTY</h2>

          <form id="applicationForm" novalidate>
            <div class="form-section">
              <p><strong>Seller:</strong> SNT RGV, LLC, P.O. Box 610, McAllen, Texas 78505</p>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="lot" class="form-label">Lot #</label>
                <input type="text" id="lot" name="lot" class="form-input" required aria-describedby="lot-error">
              </div>
              <div class="form-group">
                <label for="block" class="form-label">Block #</label>
                <input type="text" id="block" name="block" class="form-input" required aria-describedby="block-error">
              </div>
              <div class="form-group">
                <span class="form-label">Subdivision:</span>
                <span>Florida Estates Subdivision Section II, Cameron County, TX</span>
              </div>
            </div>

            <table class="buyer-table">
              <thead>
                <tr>
                  <th scope="col">Buyer Information</th>
                  <th scope="col">Co-Buyer Information</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="form-group">
                      <label for="buyerName" class="form-label">Full Name</label>
                      <input type="text" id="buyerName" name="buyerName" class="form-input" required>
                    </div>
                    <div class="form-group">
                      <label for="buyerEmail" class="form-label">Email Address</label>
                      <input type="email" id="buyerEmail" name="buyerEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                      <label for="buyerAddress" class="form-label">Street Address</label>
                      <input type="text" id="buyerAddress" name="buyerAddress" class="form-input" required>
                    </div>
                    <div class="form-group">
                      <label for="buyerCity" class="form-label">City</label>
                      <input type="text" id="buyerCity" name="buyerCity" class="form-input" required>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="buyerState" class="form-label">State</label>
                        <input type="text" id="buyerState" name="buyerState" class="form-input" maxlength="2" required>
                      </div>
                      <div class="form-group">
                        <label for="buyerZip" class="form-label">ZIP Code</label>
                        <input type="text" id="buyerZip" name="buyerZip" class="form-input" required>
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="buyerPhone" class="form-label">Phone Number</label>
                      <input type="tel" id="buyerPhone" name="buyerPhone" class="form-input" required>
                    </div>
                    <div class="form-group">
                      <label for="buyerSSN" class="form-label">SSN</label>
                      <input type="text" id="buyerSSN" name="buyerSSN" class="form-input" placeholder="000-00-0000" required>
                    </div>
                  </td>
                  <td>
                    <div class="form-group">
                      <label for="cobuyerName" class="form-label">Full Name</label>
                      <input type="text" id="cobuyerName" name="cobuyerName" class="form-input">
                    </div>
                    <div class="form-group">
                      <label for="cobuyerEmail" class="form-label">Email Address</label>
                      <input type="email" id="cobuyerEmail" name="cobuyerEmail" class="form-input">
                    </div>
                    <div class="form-group">
                      <label for="cobuyerAddress" class="form-label">Street Address</label>
                      <input type="text" id="cobuyerAddress" name="cobuyerAddress" class="form-input">
                    </div>
                    <div class="form-group">
                      <label for="cobuyerCity" class="form-label">City</label>
                      <input type="text" id="cobuyerCity" name="cobuyerCity" class="form-input">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="cobuyerState" class="form-label">State</label>
                        <input type="text" id="cobuyerState" name="cobuyerState" class="form-input" maxlength="2">
                      </div>
                      <div class="form-group">
                        <label for="cobuyerZip" class="form-label">ZIP Code</label>
                        <input type="text" id="cobuyerZip" name="cobuyerZip" class="form-input">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="cobuyerPhone" class="form-label">Phone Number</label>
                      <input type="tel" id="cobuyerPhone" name="cobuyerPhone" class="form-input">
                    </div>
                    <div class="form-group">
                      <label for="cobuyerSSN" class="form-label">SSN</label>
                      <input type="text" id="cobuyerSSN" name="cobuyerSSN" class="form-input" placeholder="000-00-0000">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <table class="financial-table">
              <thead>
                <tr>
                  <th scope="col">Financial Information</th>
                  <th scope="col">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">Purchase Price:</th>
                  <td>
                    <label for="purchasePrice" class="sr-only">Purchase Price</label>
                    $ <input type="number" id="purchasePrice" name="purchasePrice" class="form-input" step="0.01" required>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Down Payment:</th>
                  <td>
                    <label for="downPayment" class="sr-only">Down Payment</label>
                    $ <input type="number" id="downPayment" name="downPayment" class="form-input" step="0.01" required>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Amount to Finance:</th>
                  <td>
                    <label for="loanAmount" class="sr-only">Amount to Finance</label>
                    $ <input type="number" id="loanAmount" name="loanAmount" class="form-input" readonly>
                  </td>
                </tr>
                <tr>
                  <th scope="row">Interest Rate:</th>
                  <td><strong>10.00%</strong> per annum</td>
                </tr>
                <tr>
                  <th scope="row">Term of Loan:</th>
                  <td>
                    <label for="termMonths" class="sr-only">Loan Term in Months</label>
                    <input type="number" id="termMonths" name="termMonths" class="form-input" required> months
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="legal-text">
              <p>An Owner's Title Insurance Policy is not provided in this sale. Buyer may obtain a Title Insurance Policy at Buyer's expense from a title company of Buyer's choice.</p>
              
              <p>Buyer is offering to purchase the property described herein "AS IS" in its present condition. The Property is subject to certain restrictions which Buyer acknowledges having received a copy of.</p>
              
              <p>The documents signed at the closing of the sale and purchase will contain the entire agreement. Any promise or representation by any salesperson or employee of the Seller in writing or orally that is different than the documents signed at the closing is void.</p>
              
              <p>Notice Regarding Possible Annexation: If the property that is the subject of this Contract is located outside the limits of a municipality, the property may now or later be included in the extraterritorial jurisdiction of a municipality.</p>
            </div>

            <div class="signature-section">
              <h3>Signatures</h3>
              <div class="signature-row">
                <span class="signature-label">Buyer:</span>
                <button type="button" class="signature-box" id="buyerSignature" aria-label="Click to add buyer signature">
                  <span class="signature-placeholder">Click to sign</span>
                  <div class="signature-display" id="buyerSignatureDisplay"></div>
                </button>
                <span class="signature-label">Date:</span>
                <span id="buyerDate"></span>
              </div>
              
              <div class="signature-row">
                <span class="signature-label">Co-Buyer:</span>
                <button type="button" class="signature-box" id="cobuyerSignature" aria-label="Click to add co-buyer signature">
                  <span class="signature-placeholder">Click to sign</span>
                  <div class="signature-display" id="cobuyerSignatureDisplay"></div>
                </button>
                <span class="signature-label">Date:</span>
                <span id="cobuyerDate"></span>
              </div>
            </div>

            <input type="hidden" id="buyerSignatureData" name="buyerSignatureData">
            <input type="hidden" id="cobuyerSignatureData" name="cobuyerSignatureData">
          </form>
        </div>

        <div class="controls">
          <div id="statusMessage" class="status-message" role="alert" aria-live="polite"></div>
          <button type="button" class="btn" id="submitBtn">Submit Application</button>
          <div id="successActions" style="display: none;">
            <button type="button" class="btn btn-secondary" id="downloadBtn">Download PDF</button>
            <button type="button" class="btn btn-secondary" id="printBtn">Print Document</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="signatureModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Add Signature</h3>
        <button class="close-btn" id="closeModal" aria-label="Close signature modal">&times;</button>
      </div>
      
      <div class="tab-buttons" role="tablist">
        <button class="tab-btn active" id="typeTab" role="tab" aria-selected="true" aria-controls="typeContent">Type Signature</button>
        <button class="tab-btn" id="drawTab" role="tab" aria-selected="false" aria-controls="drawContent">Draw Signature</button>
      </div>
      
      <div id="typeContent" class="tab-content active" role="tabpanel" aria-labelledby="typeTab">
        <label for="signatureInput" class="sr-only">Type your signature</label>
        <input type="text" class="signature-input" id="signatureInput" placeholder="Type your signature">
      </div>
      
      <div id="drawContent" class="tab-content" role="tabpanel" aria-labelledby="drawTab">
        <canvas id="signatureCanvas" class="signature-canvas" width="500" height="200" aria-label="Draw your signature here"></canvas>
      </div>
      
      <div style="margin-top: 1.5rem; text-align: right;">
        <button class="btn btn-secondary" id="clearBtn">Clear</button>
        <button class="btn" id="saveBtn">Save Signature</button>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://holand-pdf-storage.onrender.com';
    const form = document.getElementById('applicationForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const statusMessage = document.getElementById('statusMessage');
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    let ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentTarget = null;
    let generatedPDF = null;

    // Set today's date
    const today = new Date().toLocaleDateString();
    document.getElementById('buyerDate').textContent = today;
    document.getElementById('cobuyerDate').textContent = today;

    // Initialize canvas
    function initCanvas() {
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000080';
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // Canvas drawing
    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(e) {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
      ctx.beginPath();
    }

    // Touch events
    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type.replace('touch', 'mouse').replace('start', 'down').replace('end', 'up'), {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }

    // Event listeners
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Modal functionality
    function openModal(target) {
      currentTarget = target;
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('signatureInput').value = '';
      initCanvas();
      document.getElementById('signatureInput').focus();
    }

    function closeModal() {
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      currentTarget = null;
    }

    // Tab switching
    document.getElementById('typeTab').addEventListener('click', () => {
      document.getElementById('typeTab').classList.add('active');
      document.getElementById('drawTab').classList.remove('active');
      document.getElementById('typeContent').classList.add('active');
      document.getElementById('drawContent').classList.remove('active');
      document.getElementById('typeTab').setAttribute('aria-selected', 'true');
      document.getElementById('drawTab').setAttribute('aria-selected', 'false');
    });

    document.getElementById('drawTab').addEventListener('click', () => {
      document.getElementById('drawTab').classList.add('active');
      document.getElementById('typeTab').classList.remove('active');
      document.getElementById('drawContent').classList.add('active');
      document.getElementById('typeContent').classList.remove('active');
      document.getElementById('drawTab').setAttribute('aria-selected', 'true');
      document.getElementById('typeTab').setAttribute('aria-selected', 'false');
      initCanvas();
    });

    // Signature boxes
    document.getElementById('buyerSignature').addEventListener('click', () => openModal('buyer'));
    document.getElementById('cobuyerSignature').addEventListener('click', () => openModal('cobuyer'));

    // Modal controls
    document.getElementById('closeModal').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      if (document.getElementById('typeContent').classList.contains('active')) {
        document.getElementById('signatureInput').value = '';
      } else {
        initCanvas();
      }
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      if (!currentTarget) return;
      
      const display = document.getElementById(currentTarget + 'SignatureDisplay');
      const placeholder = document.getElementById(currentTarget + 'Signature').querySelector('.signature-placeholder');
      const dataField = document.getElementById(currentTarget + 'SignatureData');
      
      if (document.getElementById('typeContent').classList.contains('active')) {
        const value = document.getElementById('signatureInput').value.trim();
        if (value) {
          display.innerHTML = `<span class="typed-signature">${value}</span>`;
          dataField.value = value;
          placeholder.style.display = 'none';
        }
      } else {
        const imageData = canvas.toDataURL();
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'drawn-signature';
        img.alt = 'Digital signature';
        display.innerHTML = '';
        display.appendChild(img);
        dataField.value = imageData;
        placeholder.style.display = 'none';
      }
      
      closeModal();
    });

    // Form calculations
    function calculateLoan() {
      const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
      const down = parseFloat(document.getElementById('downPayment').value) || 0;
      document.getElementById('loanAmount').value = (price - down).toFixed(2);
    }

    document.getElementById('purchasePrice').addEventListener('input', calculateLoan);
    document.getElementById('downPayment').addEventListener('input', calculateLoan);

    // Phone formatting
    document.querySelectorAll('input[type="tel"]').forEach(input => {
      input.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length >= 6) {
          value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
        } else if (value.length >= 3) {
          value = value.replace(/(\d{3})(\d{0,3})/, '($1) $2');
        }
        this.value = value;
      });
    });

    // SSN formatting
    document.querySelectorAll('input[id*="SSN"]').forEach(input => {
      input.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length >= 5) {
          value = value.replace(/(\d{3})(\d{2})(\d{0,4})/, '$1-$2-$3');
        } else if (value.length >= 3) {
          value = value.replace(/(\d{3})(\d{0,2})/, '$1-$2');
        }
        this.value = value;
      });
    });

    // Validation
    function validateForm() {
      const required = ['lot', 'block', 'buyerName', 'buyerEmail', 'buyerAddress', 'buyerCity', 'buyerState', 'buyerZip', 'buyerPhone', 'buyerSSN', 'purchasePrice', 'downPayment', 'termMonths'];
      
      let valid = true;
      required.forEach(id => {
        const field = document.getElementById(id);
        if (!field.value.trim()) {
          field.setCustomValidity('This field is required');
          valid = false;
        } else {
          field.setCustomValidity('');
        }
      });
      
      if (!document.getElementById('buyerSignatureData').value) {
        showStatus('Please add your signature before submitting.', 'error');
        valid = false;
      }
      
      return valid;
    }

    function showStatus(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} show`;
    }

    // Load external libraries on demand
    async function loadLibraries() {
      if (typeof html2canvas === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      }
      if (typeof window.jspdf === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      }
      if (typeof emailjs === 'undefined') {
        await loadScript('https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js');
        emailjs.init('YvkwnfiMmHhEc2zjh');
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // PDF generation
    async function generatePDF() {
      await loadLibraries();
      
      const element = document.querySelector('.document-container');
      const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff'
      });
      
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('portrait', 'mm', 'a4');
      
      const imgWidth = 210;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
      return pdf;
    }

    // Form submission
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (!validateForm()) {
        form.reportValidity();
        return;
      }
      
      loading.classList.add('active');
      submitBtn.disabled = true;
      
      try {
        showStatus('Generating PDF...', 'info');
        generatedPDF = await generatePDF();
        
        showStatus('Uploading PDF...', 'info');
        const pdfBlob = generatedPDF.output('blob');
        const formData = new FormData();
        formData.append('pdf', pdfBlob, 'application.pdf');
        formData.append('buyerName', document.getElementById('buyerName').value);
        
        const response = await fetch(`${BACKEND_URL}/upload-pdf`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const result = await response.json();
        
        showStatus('Sending email...', 'info');
        await emailjs.send('service_vu3hz9m', 'template_t6sxp4j', {
          buyer_name: document.getElementById('buyerName').value,
          buyer_email: document.getElementById('buyerEmail').value,
          lot_number: document.getElementById('lot').value,
          block_number: document.getElementById('block').value,
          purchase_price: document.getElementById('purchasePrice').value,
          submission_date: today,
          pdf_link: result.url
        });
        
        showStatus('Application submitted successfully!', 'success');
        submitBtn.style.display = 'none';
        document.getElementById('successActions').style.display = 'block';
        
      } catch (error) {
        showStatus(`Submission failed: ${error.message}`, 'error');
        console.error('Submission error:', error);
      } finally {
        loading.classList.remove('active');
        submitBtn.disabled = false;
      }
    });

    // Download and print handlers
    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (generatedPDF) {
        generatedPDF.save(`Purchase_Agreement_${document.getElementById('buyerName').value.replace(/\s+/g, '_')}.pdf`);
      }
    });

    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    // Initialize
    initCanvas();
  </script>
</body>
</html>
